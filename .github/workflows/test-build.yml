name: Test Build (Personal Repo)

on:
  push:
    branches: [chore/vercel-test-*] # í…ŒìŠ¤íŠ¸ ë¸Œëœì¹˜ì—ì„œë§Œ ì‹¤í–‰
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰

jobs:
  test-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Test build process
        run: |
          chmod +x build.sh
          ./build.sh

      - name: Verify build output
        run: |
          echo "=== Checking output directory ==="
          ls -la output/

          echo "=== Checking package.json ==="
          if [ -f "output/package.json" ]; then
            cat output/package.json
            echo "âœ… package.json exists"
          else
            echo "âŒ package.json missing"
            exit 1
          fi

          echo "=== Checking for Next.js dependency ==="
          if grep -q '"next"' output/package.json || [ -f "output/server.js" ]; then
            echo "âœ… Next.js found or Standalone mode detected"
          else
            echo "âŒ Next.js not found!"
            exit 1
          fi

          echo "=== Checking Vercel config ==="
          if [ -f "output/vercel.json" ]; then
            cat output/vercel.json
            echo "âœ… vercel.json exists"
          else
            echo "âŒ vercel.json missing"
          fi

      - name: Simulate Vercel deployment
        run: |
          cd output
          echo "=== Simulating Vercel deployment ==="

          # íŒŒì¼ êµ¬ì¡° í™•ì¸
          echo "Files in output:"
          find . -type f | head -20

          # Standalone ëª¨ë“œ í™•ì¸
          if [ -f "server.js" ]; then
            echo "âœ… Standalone mode - server.js found"
          elif [ -d ".next" ]; then
            echo "âœ… Standard Next.js build found"
          else
            echo "âŒ No valid build output found"
            exit 1
          fi

      - name: Push to main for Vercel deployment
        if: success()
        run: |
          # output ë‚´ìš©ì„ main ë¸Œëœì¹˜ë¡œ í‘¸ì‹œ (ì‹¤ì œ ë°°í¬ í…ŒìŠ¤íŠ¸)
          git config --global user.name "Test Bot"
          git config --global user.email "test@example.com"

          # ì„ì‹œ ë¸Œëœì¹˜ ìƒì„±
          git checkout --orphan temp-deploy
          git rm -rf .

          # output ë‚´ìš© ë³µì‚¬
          cp -R output/* .
          cp output/.* . 2>/dev/null || true

          git add .
          git commit -m "ğŸ§ª Test deployment from ${{ github.ref_name }}"

          # main ë¸Œëœì¹˜ ê°•ì œ ì—…ë°ì´íŠ¸ (í…ŒìŠ¤íŠ¸ìš©)
          git push origin temp-deploy:main --force
