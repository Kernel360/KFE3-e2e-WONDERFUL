# .github/workflows/cleanup-preview.yml
name: Cleanup Preview Branch

on:
  # Fork PRì—ì„œë„ ìž‘ë™í•˜ë„ë¡ pull_request_target ì‚¬ìš©
  pull_request_target:
    types: [closed]

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Delete preview branch from personal repo
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.SEUNG_GITHUB_KEY }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const branchName = `preview/pr-${prNumber}`;

            try {
              // ë¸Œëžœì¹˜ ì¡´ìž¬ í™•ì¸
              await github.rest.repos.getBranch({
                owner: 'miniseung',
                repo: 'KFE3-e2e-WONDERFUL',
                branch: branchName
              });
              
              // ë¸Œëžœì¹˜ ì‚­ì œ
              await github.rest.git.deleteRef({
                owner: 'miniseung',
                repo: 'KFE3-e2e-WONDERFUL',
                ref: `heads/${branchName}`
              });
              
              console.log(`âœ… Successfully deleted branch: ${branchName}`);
              
              // PRì— ì •ë¦¬ ì™„ë£Œ ëŒ“ê¸€ (ì„ íƒì‚¬í•­)
              try {
                await github.rest.issues.createComment({
                  issue_number: prNumber,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: `ðŸ§¹ **Preview ë¸Œëžœì¹˜ ì •ë¦¬ ì™„ë£Œ**\n\nðŸ“ ì‚­ì œëœ ë¸Œëžœì¹˜: \`${branchName}\`\nâ° ì •ë¦¬ ì‹œê°„: ${new Date().toLocaleString('ko-KR')}`
                });
              } catch (commentError) {
                console.log('â„¹ï¸ ëŒ“ê¸€ ìž‘ì„± ì‹¤íŒ¨ (ê¶Œí•œ ë¬¸ì œì¼ ìˆ˜ ìžˆìŒ)');
              }
              
            } catch (error) {
              if (error.status === 404) {
                console.log(`â„¹ï¸ Branch ${branchName} does not exist or already deleted`);
              } else {
                console.error(`âŒ Error deleting branch ${branchName}:`, error.message);
                throw error;
              }
            }

      - name: Create cleanup summary
        run: |
          echo "ðŸ§¹ **Preview ë¸Œëžœì¹˜ ì •ë¦¬ ì™„ë£Œ**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **ì‚­ì œëœ ë¸Œëžœì¹˜**: \`preview/pr-${{ github.event.pull_request.number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "â° **ì •ë¦¬ ì‹œê°„**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ‘¤ **PR ìž‘ì„±ìž**: ${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
