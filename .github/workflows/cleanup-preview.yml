# .github/workflows/cleanup-preview.yml
name: Cleanup Preview Branch

on:
  pull_request_target:
    types: [closed]

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Delete preview branch from personal repo
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.SEUNG_GITHUB_KEY }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const branchName = `preview/pr-${prNumber}`;

            console.log(`ðŸ§¹ Starting cleanup for PR #${prNumber}`);
            console.log(`ðŸŽ¯ Target branch: ${branchName}`);

            try {
              // ë¸Œëžœì¹˜ ì¡´ìž¬ í™•ì¸
              console.log('ðŸ” Checking if branch exists...');
              await github.rest.repos.getBranch({
                owner: 'miniseung',
                repo: 'KFE3-e2e-WONDERFUL',
                branch: branchName
              });
              
              console.log('âœ… Branch exists, proceeding with deletion...');
              
              // ë¸Œëžœì¹˜ ì‚­ì œ
              await github.rest.git.deleteRef({
                owner: 'miniseung',
                repo: 'KFE3-e2e-WONDERFUL',
                ref: `heads/${branchName}`
              });
              
              console.log(`âœ… Successfully deleted branch: ${branchName}`);
              
              // ì„±ê³µ ëŒ“ê¸€ ìž‘ì„±
              try {
                console.log('ðŸ’¬ Creating cleanup comment...');
                const successMessage = 'ðŸ§¹ **Preview ë¸Œëžœì¹˜ ì •ë¦¬ ì™„ë£Œ**\n\n' +
                  `ðŸ“ **ì‚­ì œëœ ë¸Œëžœì¹˜**: \`${branchName}\`\n` +
                  `â° **ì •ë¦¬ ì‹œê°„**: ${new Date().toLocaleString('ko-KR')}\n` +
                  'ðŸ—‘ï¸ **ìƒíƒœ**: ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë¨\n\n' +
                  '> í•´ë‹¹ Vercel ë°°í¬ë„ ìžë™ìœ¼ë¡œ ì •ë¦¬ë©ë‹ˆë‹¤.';
                
                const response = await github.rest.issues.createComment({
                  issue_number: prNumber,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: successMessage
                });
                console.log(`âœ… Cleanup comment created (ID: ${response.data.id})`);
              } catch (commentError) {
                console.warn('âš ï¸ ëŒ“ê¸€ ìž‘ì„± ì‹¤íŒ¨ (ê¶Œí•œ ë¬¸ì œì¼ ìˆ˜ ìžˆìŒ):', commentError.message);
              }
              
            } catch (error) {
              if (error.status === 404) {
                console.log(`â„¹ï¸ Branch ${branchName} does not exist or already deleted`);
                
                // ë¸Œëžœì¹˜ê°€ ì—†ëŠ” ê²½ìš° ëŒ“ê¸€
                try {
                  const notFoundMessage = 'ðŸ§¹ **Preview ë¸Œëžœì¹˜ ì •ë¦¬ í™•ì¸**\n\n' +
                    `ðŸ“ **ëŒ€ìƒ ë¸Œëžœì¹˜**: \`${branchName}\`\n` +
                    `â° **í™•ì¸ ì‹œê°„**: ${new Date().toLocaleString('ko-KR')}\n` +
                    'â„¹ï¸ **ìƒíƒœ**: ë¸Œëžœì¹˜ê°€ ì´ë¯¸ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤\n\n' +
                    '> ì •ë¦¬ê°€ ì™„ë£Œëœ ìƒíƒœìž…ë‹ˆë‹¤.';
                  
                  await github.rest.issues.createComment({
                    issue_number: prNumber,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: notFoundMessage
                  });
                } catch (commentError) {
                  console.warn('âš ï¸ ì •ë¦¬ í™•ì¸ ëŒ“ê¸€ ìž‘ì„± ì‹¤íŒ¨:', commentError.message);
                }
              } else {
                console.error(`âŒ Error deleting branch ${branchName}:`, error.message);
                console.error('âŒ Full error:', error);
                
                // ì—ëŸ¬ ëŒ“ê¸€ ìž‘ì„±
                try {
                  const errorMessage = 'âŒ **Preview ë¸Œëžœì¹˜ ì •ë¦¬ ì‹¤íŒ¨**\n\n' +
                    `ðŸ“ **ëŒ€ìƒ ë¸Œëžœì¹˜**: \`${branchName}\`\n` +
                    `â° **ì‹œë„ ì‹œê°„**: ${new Date().toLocaleString('ko-KR')}\n` +
                    `âŒ **ì—ëŸ¬**: ${error.message}\n\n` +
                    '> ìˆ˜ë™ìœ¼ë¡œ ë¸Œëžœì¹˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
                  
                  await github.rest.issues.createComment({
                    issue_number: prNumber,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: errorMessage
                  });
                } catch (commentError) {
                  console.warn('âš ï¸ ì—ëŸ¬ ëŒ“ê¸€ ìž‘ì„± ì‹¤íŒ¨:', commentError.message);
                }
                
                throw error;
              }
            }

      - name: Create cleanup summary
        run: |
          echo "ðŸ§¹ **Preview ë¸Œëžœì¹˜ ì •ë¦¬ ì™„ë£Œ**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **ì‚­ì œ ëŒ€ìƒ**: \`preview/pr-${{ github.event.pull_request.number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "â° **ì •ë¦¬ ì‹œê°„**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ‘¤ **PR ìž‘ì„±ìž**: ${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Personal Repo**: https://github.com/miniseung/KFE3-e2e-WONDERFUL" >> $GITHUB_STEP_SUMMARY
